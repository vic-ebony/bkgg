{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>動物園每日展示</title>
  <!-- 若其他欄位仍需 Choices.js，可保留；此處主要用勾選框 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <style>
    /* 全站基本設定：字型、尺寸與背景 */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
      box-sizing: border-box;
      font-family: Arial, sans-serif;
      font-size: 16px;
      background: url('{% static "image/background.jpg" %}') no-repeat center center/cover;
      display: flex;
      flex-direction: column;
      line-height: 1.5;
    }
    *, *::before, *::after { box-sizing: inherit; }
    
    /* 右上角會員資訊 */
    .user-info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.8);
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .user-info form { display: inline; }
    .user-info button {
      background: transparent;
      border: none;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
      margin-left: 10px;
    }
    
    /* 側邊與遮罩 */
    #menuBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      padding: 0.5rem 1rem;
      font-size: 1.5rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    #overlay.open { opacity: 1; pointer-events: auto; }
    #sidePanel {
      position: absolute;
      top: 0;
      left: -250px;
      width: 250px;
      height: 100%;
      background: #fff;
      transition: left 0.3s ease;
      z-index: 1002;
      padding: 1.25rem;
    }
    #sidePanel.open { left: 0; }
    #sidePanel button {
      display: block;
      width: 100%;
      margin-bottom: 0.625rem;
      padding: 0.625rem;
      border: none;
      background: #f8f8f8;
      font-size: 1.125rem;
      text-align: left;
      cursor: pointer;
      border-radius: 5px;
    }
    /* 待約清單按鈕 */
    #pendingListBtn {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    
    /* 主內容區 */
    .glass-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      overflow: hidden;
    }
    .glass-background { display: none; }
    .content {
      position: relative;
      z-index: 1;
      background: #fff;
      padding: 1.25rem;
      border-radius: 15px;
      width: 95%;
      max-width: 500px;
      margin: 1.25rem auto;
      flex-grow: 1;
      overflow: hidden;
      animation: fadeInUp 1s forwards;
      transform: translateZ(0);
      will-change: opacity, transform;
      background-clip: padding-box;
      display: flex;
      flex-direction: column;
    }
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    /* 導覽列 */
    .hall-menu {
      display: flex;
      overflow-x: auto;
      gap: 0.625rem;
      background: transparent;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 0;
      margin-bottom: 0.625rem;
    }
    .hall-menu a {
      flex-shrink: 0;
      padding: 0.5rem 0.75rem;
      text-decoration: none;
      color: #666;
      background: #fff;
      border: none;
      border-radius: 5px;
      white-space: nowrap;
      transition: background 0.3s;
      font-size: 1.05rem;
    }
    .hall-menu a.active,
    .hall-menu a:hover {
      background: #e0f7fa;
      color: #007bff;
      border-color: #bce8f1;
    }
    
    /* 上方區：照片與介紹，保留你原本針對手機設定的高度 */
    .top-section {
      display: flex;
      align-items: stretch;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.625rem;
    }
    .photo-area {
      flex: 0 0 50%;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid #ccc;
      background: #fff;
      padding: 0.625rem;
    }
    .photo-area img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .intro-area {
      flex: 0 0 50%;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      height: 300px;
    }
    .intro-top {
      flex: 1;
      overflow-y: auto;
    }
    .intro-top p { margin: 0; font-size: 1rem; color: #333; }
    
    .page-title {
      text-align: center;
      margin-bottom: 0.625rem;
      color: #666;
      font-size: 2rem;
    }
    
    /* 表格區 */
    .table-wrapper {
      margin-top: 0;
      background: #fff;
      border: none;
      border-radius: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    .header-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      flex-shrink: 0;
    }
    .header-table th {
      padding: 0.5rem 0.3rem;
      border-bottom: 2px solid #ccc;
      text-align: left;
      background: #e9ecef;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: break-word;
      line-height: 1;
      vertical-align: middle;
      font-size: 0.9rem;
      color: #495057;
      font-weight: bold;
    }
    .header-table th:nth-child(1),
    .body-table td:nth-child(1) { width: 17%; text-align: center; }
    .header-table th:nth-child(2),
    .body-table td:nth-child(2) { width: 50%; }
    .header-table th:nth-child(3),
    .body-table td:nth-child(3) { width: 35%; }
    
    .body-wrapper {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-bottom: 1px solid #dee2e6;
    }
    .body-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .body-table td {
      padding: 0.5rem 0.3rem;
      border-top: 1px solid #dee2e6;
      text-align: left;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: break-word;
      background: #fff;
      line-height: 1.5;
      vertical-align: middle;
      font-size: 1rem;
      color: #444;
    }
    .body-table tr:hover { background: #f8f9fa; cursor: pointer; }
    .time-slot { display: inline-block; margin-right: 0.3em; }
    
    .beautician-cell {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 0.3rem;
    }
    .beautician-cell .labels .label {
      display: inline-block;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      color: #fff;
      margin-right: 0.25rem;
      line-height: 1.2;
    }
    .beautician-cell .labels .newcomer { background: rgba(40, 167, 69, 0.4); }
    .beautician-cell .labels .hot { background: rgba(220, 53, 69, 0.4); }
    .beautician-cell .labels .exclusive { background: rgba(111, 66, 193, 0.4); }
    
    .beautician-text .name-size-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      width: 100%;
      gap: 0.5rem;
    }
    .name-container .name {
      font-size: 1rem;
      color: #212529;
      font-weight: 520;
      flex-grow: 1;
      word-break: break-all;
    }
    .size-container .size {
      font-size: 0.9rem;
      color: #888;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .review-actions {
      display: flex;
      align-items: center;
      margin-top: 0.4rem;
      gap: 0.6rem;
    }
    .review-box {
      display: inline-flex;
      align-items: center;
      background: #f0f0f0;
      color: #555;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9rem;
      user-select: none;
      transition: background 0.3s;
      border: 1px solid #ccc;
      min-width: 70px;
      justify-content: center;
    }
    .review-box:hover { background: #e0e0e0; }
    .review-box .count {
      margin-left: 0.3rem;
      font-weight: bold;
      color: #333;
    }
    .circle-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid #ccc;
      background-color: #fff;
      font-size: 1.1rem;
      line-height: 1;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, color 0.2s;
    }
    .circle-btn:hover {
      background-color: #f0f0f0;
      color: #555;
    }
    .dropdown-menu {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1100;
      position: absolute;
      display: none;
    }
    .dropdown-menu button {
      display: block;
      width: 100%;
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
    }
    .dropdown-menu button:hover { background: #f8f8f8; }
    .review-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fafafa;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #ddd;
      margin-bottom: 1rem;
      font-size: 1.125rem;
      color: #333;
    }
    .review-user-info { display: flex; flex-direction: column; }
    .review-user { color: #333; }
    .review-total { font-size: 0.875rem; color: #666; }
    .review-body p { margin: 0.3rem 0; font-size: 1rem; color: #555; }
    .review-body p strong { color: #333; }
    .review-line {
      display: flex;
      align-items: flex-start;
      margin: 0.3rem 0;
    }
    .review-label { flex: 0 0 50px; font-weight: bold; }
    .review-value {
      flex: 1;
      overflow-wrap: break-word;
      word-break: break-all;
      color: #666;
    }
    #reviewList p { white-space: pre-wrap; word-wrap: break-word; margin: 0.5rem 0; }
    
    /* 新增待約清單內容樣式 - 緊湊版 */
    .pending-item {
      display: flex;
      align-items: center;
      border: 1px dashed #888;
      padding: 0.25rem;
      margin-bottom: 0.25rem;
    }
    .pending-thumb {
      border: 1px dashed #888;
      padding: 0.125rem;
      margin-right: 0.25rem;
    }
    .pending-thumb img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 50%;
    }
    .pending-info {
      flex-grow: 1;
      border: 1px dashed #888;
      padding: 0.125rem;
    }
    .pending-name {
      font-weight: bold;
      margin-bottom: 0.125rem;
      border: 1px dashed #888;
      padding: 0.125rem;
    }
    .pending-field {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin: 2px 0;
    }
    .field-label {
      width: 30%;
      text-align: left;
      font-size: 0.8rem;
      color: #555;
    }
    .field-value {
      width: 70%;
      text-align: left;
      word-break: break-all;
      font-size: 0.8rem;
      color: #555;
    }
    /* 修正：待約標籤區，顯示新人、熱門、獨家標籤 */
    .pending-labels {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      margin-top: 0.125rem;
      border: 1px dashed #888;
      padding: 0.125rem;
    }
    .labels-content span.label {
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      color: #fff;
      margin-right: 0.25rem;
      line-height: 1.2;
    }
    .label.newcomer { background: rgba(40, 167, 69, 0.4); }
    .label.hot { background: rgba(220, 53, 69, 0.4); }
    .label.exclusive { background: rgba(111, 66, 193, 0.4); }
    .pending-review-btn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .pending-remove {
      flex-shrink: 0;
      white-space: nowrap;
      border: 1px dashed #888;
      padding: 0.125rem;
      margin-left: 0.25rem;
    }
    .remove-btn {
      background: red;
      color: #fff;
      border: none;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    
    /* Modal 樣式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    /* 調整心得評論 Modal 的 z-index 較高 */
    #reviewModal {
      z-index: 50;
    }
    .modal-content {
      background-color: #fff;
      margin: 1.25rem auto;
      padding: 1.25rem;
      border-radius: 15px;
      width: 95%;
      max-width: 500px;
      height: calc(100vh - 2.5rem);
      display: flex;
      flex-direction: column;
      overflow: auto;
      position: relative;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.75rem;
      font-weight: bold;
      cursor: pointer;
      color: #666;
    }
    .form-group { margin-bottom: 0.9375rem; }
    .form-group label { display: block; margin-bottom: 0.3125rem; font-weight: bold; }
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="number"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.5rem;
      box-sizing: border-box;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    .form-group textarea { resize: vertical; }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #999;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
    }
    button {
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #f8f8f8; }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .checkbox-group label { cursor: pointer; }
    
    /* 保留你原本針對手機設定的高度 */
    @media (max-width: 480px) {
      .content { padding: 0.625rem; }
      .photo-area, .intro-area { height: 200px; }
      .intro-area { padding: 0.625rem; }
    }
  </style>
</head>
<body>
  {% if user.is_authenticated %}
  <div class="user-info">
    <span>登入中：{{ user.first_name|default:user.username }}</span>
    <form action="{% url 'logout' %}" method="post">
      {% csrf_token %}
      <button type="submit">登出</button>
    </form>
  </div>
  {% endif %}
  
  <div class="glass-overlay">
    <div class="glass-background"></div>
    <div class="content">
      <div id="overlay"></div>
      <div id="sidePanel">
        <button>每日班表</button>
        <button>每週班表</button>
        <button>最新心得</button>
        <button>找美容師</button>
        <button>最愛清單</button>
        <!-- 待約清單按鈕：改用後端傳入數量 -->
        <button id="pendingListBtn" data-count="{% if pending_appointments %}{{ pending_appointments|length }}{% else %}0{% endif %}">
          待約清單 ({% if pending_appointments %}{{ pending_appointments|length }}{% else %}0{% endif %})
        </button>
        <button id="loginBtn">會員登入</button>
      </div>
      <button id="menuBtn" aria-label="打開選單">≡</button>
      <div class="page-title">每日班表</div>
      <section class="top-section">
        <div class="photo-area" id="photoArea">
          {% if animals|length > 0 and animals.0.photo %}
            <img src="{{ animals.0.photo.url }}" alt="{{ animals.0.name }}">
          {% else %}
            <p>尚無照片</p>
          {% endif %}
        </div>
        <div class="intro-area" id="introArea">
          <div class="intro-top">
            {% if animals|length > 0 and animals.0.introduction %}
              <p id="introductionContent">{{ animals.0.introduction }}</p>
            {% else %}
              <p id="introductionContent"></p>
            {% endif %}
          </div>
        </div>
      </section>
      <nav class="hall-menu">
        <a href="{% url 'home' %}" class="{% if not request.GET.hall_id %}active{% endif %}">全部</a>
        {% for hall in halls %}
          <a href="{% url 'home' %}?hall_id={{ hall.id }}" class="{% if request.GET.hall_id|stringformat:"s" == hall.id|stringformat:"s" %}active{% endif %}">
            {{ hall.name }}
          </a>
        {% endfor %}
      </nav>
      
      <div class="table-wrapper">
        <table class="header-table">
          <thead>
            <tr>
              <th>台費</th>
              <th>美容師</th>
              <th>時段</th>
            </tr>
          </thead>
        </table>
        <div class="body-wrapper">
          <table class="body-table" id="animalTable">
            <tbody>
              {% for animal in animals %}
              <tr data-photo="{% if animal.photo %}{{ animal.photo.url }}{% else %}尚無照片{% endif %}"
                  data-intro="{{ animal.introduction|default:'尚無介紹' }}"
                  data-animal-id="{{ animal.id }}"
                  data-hall="{{ animal.hall.name }}"
                  data-review-count="{{ animal.approved_review_count }}">
                <td>{{ animal.fee }}</td>
                <td>
                  <div class="beautician-cell">
                    <div class="labels">
                      {% if animal.is_newcomer %}
                        <span class="label newcomer">新人</span>
                      {% endif %}
                      {% if animal.is_hot %}
                        <span class="label hot">熱門</span>
                      {% endif %}
                      {% if animal.is_exclusive %}
                        <span class="label exclusive">獨家</span>
                      {% endif %}
                    </div>
                    <div class="beautician-text">
                      <div class="name-size-line">
                        <div class="name-container">
                          <span class="name">{{ animal.name }}</span>
                        </div>
                        <div class="size-container">
                          <span class="size">{{ animal.size_display }}</span>
                        </div>
                      </div>
                      <div class="review-actions">
                        <div class="review-box" id="reviewBox-{{ animal.id }}" data-animal-id="{{ animal.id }}">
                          心得 <span class="count">{{ animal.approved_review_count }}</span>
                        </div>
                        <button class="circle-btn plus-menu-btn" aria-label="新增">+</button>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="time-cell">{{ animal.time_slot }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      {% if login_error %}
      <div style="color: red; text-align: center;">{{ login_error }}</div>
      {% endif %}
    </div>
  </div>
  
  <!-- 會員登入 Modal -->
  <div id="loginModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span class="close-modal" id="closeLoginModal" aria-label="關閉">&times;</span>
      <h2>會員登入</h2>
      <form id="loginForm" action="{% url 'login' %}" method="POST">
        {% csrf_token %}
        <div class="form-group">
          <label for="username">帳號：</label>
          <input type="text" id="username" name="username" placeholder="請輸入帳號">
        </div>
        <div class="form-group">
          <label for="password">密碼：</label>
          <input type="password" id="password" name="password" placeholder="請輸入密碼">
        </div>
        <button type="submit">登入</button>
      </form>
    </div>
  </div>
  
  <!-- 心得評論 Modal (z-index 較高，覆蓋待約清單) -->
  <div id="reviewModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span class="close-modal" id="closeReviewModal" aria-label="關閉">&times;</span>
      <h2>心得評論</h2>
      <div id="reviewList"></div>
      <form id="reviewForm" style="display:none;">
        {% csrf_token %}
        <!-- 年紀 -->
        <div class="form-group">
          <label for="age">年紀</label>
          <input type="number" id="age" name="age" placeholder="請輸入大約年紀數字, 不可有中文字">
        </div>
        <!-- 顏值 -->
        <div class="form-group">
          <label for="looks">顏值</label>
          <select id="looks" name="looks">
            <option value="">請選擇</option>
            <option value="S級 (一見難忘)">S級 (一見難忘)</option>
            <option value="A級 (出眾)">A級 (出眾)</option>
            <option value="B級 (優異)">B級 (優異)</option>
            <option value="C級 (中上)">C級 (中上)</option>
            <option value="D級 (大眾)">D級 (大眾)</option>
            <option value="E級 (較平凡)">E級 (較平凡)</option>
          </select>
        </div>
        <!-- 臉蛋（勾選框，最多選3個） -->
        <div class="form-group">
          <label>臉蛋（最多選3個）</label>
          <div id="faceCheckboxes" class="checkbox-group">
            <label><input type="checkbox" name="face" value="醫美"> 醫美</label>
            <label><input type="checkbox" name="face" value="可愛"> 可愛</label>
            <label><input type="checkbox" name="face" value="甜美"> 甜美</label>
            <label><input type="checkbox" name="face" value="稚嫩"> 稚嫩</label>
            <label><input type="checkbox" name="face" value="呆萌"> 呆萌</label>
            <label><input type="checkbox" name="face" value="清秀"> 清秀</label>
            <label><input type="checkbox" name="face" value="清純"> 清純</label>
            <label><input type="checkbox" name="face" value="仙氣"> 仙氣</label>
            <label><input type="checkbox" name="face" value="艷麗"> 艷麗</label>
            <label><input type="checkbox" name="face" value="性感"> 性感</label>
            <label><input type="checkbox" name="face" value="古典"> 古典</label>
            <label><input type="checkbox" name="face" value="個性"> 個性</label>
            <label><input type="checkbox" name="face" value="鄰家"> 鄰家</label>
            <label><input type="checkbox" name="face" value="大眾"> 大眾</label>
            <label><input type="checkbox" name="face" value="平凡"> 平凡</label>
            <label><input type="checkbox" name="face" value="單眼皮"> 單眼皮</label>
            <label><input type="checkbox" name="face" value="輕熟"> 輕熟</label>
            <label><input type="checkbox" name="face" value="熟女"> 熟女</label>
          </div>
        </div>
        <!-- 氣質（勾選框，最多選3個） -->
        <div class="form-group">
          <label>氣質（最多選3個）</label>
          <div id="temperamentCheckboxes" class="checkbox-group">
            <label><input type="checkbox" name="temperament" value="優雅"> 優雅</label>
            <label><input type="checkbox" name="temperament" value="成熟"> 成熟</label>
            <label><input type="checkbox" name="temperament" value="清新"> 清新</label>
            <label><input type="checkbox" name="temperament" value="自然"> 自然</label>
            <label><input type="checkbox" name="temperament" value="禮貌"> 禮貌</label>
            <label><input type="checkbox" name="temperament" value="女友感"> 女友感</label>
            <label><input type="checkbox" name="temperament" value="女人味"> 女人味</label>
            <label><input type="checkbox" name="temperament" value="OL"> OL</label>
            <label><input type="checkbox" name="temperament" value="台妹"> 台妹</label>
            <label><input type="checkbox" name="temperament" value="普通"> 普通</label>
          </div>
        </div>
        <!-- 體態（下拉選單） -->
        <div class="form-group">
          <label for="physique">體態</label>
          <select id="physique" name="physique">
            <option value="">請選擇體態</option>
            <option value="骨感">骨感</option>
            <option value="瘦">瘦</option>
            <option value="瘦有肉">瘦有肉</option>
            <option value="標準">標準</option>
            <option value="曲線迷人">曲線迷人</option>
            <option value="瘦偏肉">瘦偏肉</option>
            <option value="微肉">微肉</option>
            <option value="棉花糖">棉花糖</option>
          </select>
        </div>
        <!-- 罩杯（下拉選單加輸入框） -->
        <div class="form-group">
          <label for="cup">罩杯</label>
          <select id="cup" name="cup">
            <option value="">請選擇</option>
            <option value="天然">天然</option>
            <option value="醫美">醫美</option>
            <option value="自體醫美">自體醫美</option>
            <option value="不確定">不確定</option>
          </select>
          <input type="text" id="cup_size" name="cup_size" placeholder="請填寫罩杯大約大小 A~L英文字母, 不可有中文字" style="margin-top:0.5rem;" pattern="[A-L]">
        </div>
        <!-- 膚質 -->
        <div class="form-group">
          <label for="skin_texture">膚質</label>
          <select id="skin_texture" name="skin_texture">
            <option value="">請選擇</option>
            <option value="絲滑">絲滑</option>
            <option value="還不錯">還不錯</option>
            <option value="正常">正常</option>
            <option value="普通">普通</option>
          </select>
        </div>
        <!-- 膚色 -->
        <div class="form-group">
          <label for="skin_color">膚色</label>
          <select id="skin_color" name="skin_color">
            <option value="">請選擇</option>
            <option value="白皙">白皙</option>
            <option value="偏白">偏白</option>
            <option value="正常黃">正常黃</option>
            <option value="偏黃">偏黃</option>
            <option value="健康黑">健康黑</option>
          </select>
        </div>
        <!-- 音樂 -->
        <div class="form-group">
          <label for="music">音樂</label>
          <select id="music" name="music">
            <option value="">請選擇</option>
            <option value="未詢問">未詢問</option>
            <option value="無此服務">無此服務</option>
            <option value="可加值">可加值 (費用待填)</option>
            <option value="自談">可加值 (自談)</option>
          </select>
          <input type="number" id="music_price" name="music_price" placeholder="請填寫大約金額數字, 不可有中文字" style="display:none; margin-top:0.5rem;">
        </div>
        <!-- 體育 -->
        <div class="form-group">
          <label for="sports">體育</label>
          <select id="sports" name="sports">
            <option value="">請選擇</option>
            <option value="未詢問">未詢問</option>
            <option value="無此服務">無此服務</option>
            <option value="可加值">可加值 (費用待填)</option>
            <option value="自談">可加值 (自談)</option>
            <option value="體含音">體含音</option>
          </select>
          <input type="number" id="sports_price" name="sports_price" placeholder="請填寫大約金額數字, 不可有中文字" style="display:none; margin-top:0.5rem;">
        </div>
        <!-- 尺度 -->
        <div class="form-group">
          <label>尺度</label>
          <div id="scaleCheckboxes" class="checkbox-group">
            <label><input type="checkbox" name="scale" value="三光"> 三光</label>
            <label><input type="checkbox" name="scale" value="兩光"> 兩光</label>
            <label><input type="checkbox" name="scale" value="LG"> LG</label>
            <label><input type="checkbox" name="scale" value="親"> 親</label>
            <label><input type="checkbox" name="scale" value="舔"> 舔</label>
            <label><input type="checkbox" name="scale" value="伸"> 伸</label>
            <label><input type="checkbox" name="scale" value="摸"> 摸</label>
            <label><input type="checkbox" name="scale" value="磨"> 磨</label>
          </div>
        </div>
        <!-- 心得 -->
        <div class="form-group">
          <label for="content">心得</label>
          <textarea name="content" id="content" placeholder="請填寫心得" rows="4" style="width:100%;"></textarea>
        </div>
        <button type="submit">提交評論</button>
      </form>
    </div>
  </div>
  
  <!-- 新增待約清單 Modal -->
  <div id="pendingListModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span class="close-modal" id="closePendingListModal" aria-label="關閉">&times;</span>
      <h2>待約清單</h2>
      <div id="pendingListContent">
        {% if pending_appointments %}
          {% for appointment in pending_appointments %}
            <div class="pending-item" data-animal-id="{{ appointment.animal.id }}">
              <div class="pending-thumb">
                {% if appointment.animal.photo %}
                  <img src="{{ appointment.animal.photo.url }}" alt="{{ appointment.animal.name }}">
                {% else %}
                  <div style="width:50px;height:50px;background:#ccc;border-radius:50%;margin-right:0.5rem;"></div>
                {% endif %}
              </div>
              <div class="pending-info">
                <div class="pending-name">{{ appointment.animal.name }}</div>
                <div class="pending-field">
                  <div class="field-label">館別</div>
                  <div class="field-value">{{ appointment.animal.hall.name }}</div>
                </div>
                <div class="pending-field">
                  <div class="field-label">身材</div>
                  <div class="field-value">{{ appointment.animal.size_display }}</div>
                </div>
                <div class="pending-field">
                  <div class="field-label">台費</div>
                  <div class="field-value">{{ appointment.animal.fee }}</div>
                </div>
                <div class="pending-field">
                  <div class="field-label">時段</div>
                  <div class="field-value">{{ appointment.animal.time_slot }}</div>
                </div>
                <div class="pending-labels">
                  <div class="labels-content">
                    {% if appointment.animal.is_newcomer %}
                      <span class="label newcomer">新人</span>
                    {% endif %}
                    {% if appointment.animal.is_hot %}
                      <span class="label hot">熱門</span>
                    {% endif %}
                    {% if appointment.animal.is_exclusive %}
                      <span class="label exclusive">獨家</span>
                    {% endif %}
                  </div>
                  <button class="pending-review-btn" onclick="showReviewModal('{{ appointment.animal.id }}')">
                    心得 ({{ appointment.animal.approved_review_count }})
                  </button>
                </div>
              </div>
              <div class="pending-remove">
                <button class="remove-btn" onclick="removePendingItem('{{ appointment.animal.id }}', this)">移除</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p>尚無待約項目</p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div id="plusDropdown" class="dropdown-menu"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    // 打開心得 Modal，覆蓋待約清單
    function showReviewModal(animalId) {
      document.getElementById('reviewModal').style.display = 'block';
      document.getElementById('reviewList').style.display = 'block';
      document.getElementById('reviewForm').style.display = 'none';
      loadReviews(animalId);
    }
    
    // 取得 CSRF Token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // 處理音樂與體育加值輸入框顯示
    function togglePriceInput(selectId, inputId) {
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);
      select.addEventListener('change', function() {
        if (select.value === "可加值") {
          input.style.display = "block";
        } else {
          input.style.display = "none";
          input.value = "";
        }
      });
    }
    
    // 同步表頭與表身欄位寬度
    function syncTableColumnWidths() {
      const headerTable = document.querySelector('.header-table');
      const bodyTable = document.querySelector('.body-table');
      const headerCells = headerTable.querySelectorAll('th');
      const firstBodyRow = bodyTable.querySelector('tr');
      if (!firstBodyRow) return;
      const bodyCells = firstBodyRow.querySelectorAll('td');
      headerCells.forEach((th, index) => {
        const cellWidth = bodyCells[index].getBoundingClientRect().width;
        th.style.width = cellWidth + "px";
      });
    }
    
    // 處理時段欄：以 "." 分割，並包入 span
    function processTimeSlotCells() {
      document.querySelectorAll('.time-cell').forEach(function(td) {
        let text = td.textContent.trim();
        let tokens = text.split('.').filter(token => token.trim() !== '');
        tokens = tokens.map(token => '<span class="time-slot">' + token + '.</span>');
        td.innerHTML = tokens.join('');
      });
    }
    
    // 新增待約清單項目：加入待約後重新整理頁面
    function addToPendingList(row) {
      const animalId = row.getAttribute('data-animal-id');
      fetch("{% url 'add_pending' %}", {
        method: "POST",
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ 'animal_id': animalId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.error);
        }
      });
    }
    
    // 從後端移除待約項目，並更新前端顯示
    function removePendingItem(animalId, btnElem) {
      fetch("{% url 'remove_pending' %}", {
        method: "POST",
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ 'animal_id': animalId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const item = btnElem.closest('.pending-item');
          item.remove();
          updatePendingCount();
        } else {
          alert(data.error);
        }
      });
    }
    
    function updatePendingCount() {
      const pendingItems = document.querySelectorAll('.pending-item');
      const pendingBtn = document.getElementById('pendingListBtn');
      const count = pendingItems.length;
      pendingBtn.setAttribute('data-count', count);
      pendingBtn.innerText = `待約清單 (${count})`;
    }
    
    // 顯示下拉選單：提供「填寫心得」、「加入待約」、「加入筆記」
    function showPlusDropdown(triggerBtn) {
      const dropdown = document.getElementById('plusDropdown');
      dropdown.innerHTML = "";
      const btnReview = document.createElement('button');
      btnReview.textContent = "填寫心得";
      const btnAddWait = document.createElement('button');
      btnAddWait.textContent = "加入待約";
      const btnAddNote = document.createElement('button');
      btnAddNote.textContent = "加入筆記";
      
      dropdown.appendChild(btnReview);
      dropdown.appendChild(btnAddWait);
      dropdown.appendChild(btnAddNote);
      
      const rect = triggerBtn.getBoundingClientRect();
      dropdown.style.top = rect.bottom + "px";
      dropdown.style.left = rect.left + "px";
      dropdown.style.display = "block";
      
      // 取得該美容師所在的 row
      const row = triggerBtn.closest('tr');
      const animalId = row.getAttribute('data-animal-id');
      
      btnReview.addEventListener('click', function(e) {
        document.getElementById('reviewModal').style.display = 'block';
        document.getElementById('reviewForm').style.display = 'block';
        document.getElementById('reviewList').style.display = 'block';
        document.getElementById('reviewForm').setAttribute('data-animal-id', animalId);
        dropdown.style.display = 'none';
        e.stopPropagation();
      });
      btnAddWait.addEventListener('click', function(e) {
        addToPendingList(row);
        dropdown.style.display = 'none';
        e.stopPropagation();
      });
      btnAddNote.addEventListener('click', function(e) {
        alert("加入筆記功能待實作");
        dropdown.style.display = 'none';
        e.stopPropagation();
      });
    }
    
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('plusDropdown');
      if(dropdown.style.display === 'block') { dropdown.style.display = 'none'; }
    });
    
    // 限制勾選框最多選擇數量（用於臉蛋與氣質）
    function limitCheckboxSelection(containerId, max) {
      const container = document.getElementById(containerId);
      container.addEventListener('change', function() {
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const checked = container.querySelectorAll('input[type="checkbox"]:checked');
        if(checked.length >= max) {
          checkboxes.forEach(cb => { if(!cb.checked) { cb.disabled = true; } });
        } else {
          checkboxes.forEach(cb => { cb.disabled = false; });
        }
      });
    }
    
    window.addEventListener('resize', syncTableColumnWidths);
    document.addEventListener('DOMContentLoaded', function() {
      syncTableColumnWidths();
      processTimeSlotCells();
      
      // 處理音樂與體育加值輸入框顯示
      togglePriceInput("music", "music_price");
      togglePriceInput("sports", "sports_price");
      
      const tableRows = document.querySelectorAll('#animalTable tbody tr');
      tableRows.forEach(function(row) {
        row.addEventListener('click', function() {
          const photoUrl = this.getAttribute('data-photo');
          const photoArea = document.getElementById('photoArea');
          if(photoUrl === "尚無照片") {
            photoArea.innerHTML = '<p>尚無照片</p>';
          } else {
            const imgElement = photoArea.querySelector('img');
            if (imgElement) {
              imgElement.src = photoUrl;
              imgElement.alt = this.cells[1].querySelector('.beautician-text').textContent;
            } else {
              photoArea.innerHTML = '';
              const newImg = document.createElement('img');
              newImg.src = photoUrl;
              newImg.alt = this.cells[1].querySelector('.beautician-text').textContent;
              photoArea.appendChild(newImg);
            }
          }
          const introText = this.getAttribute('data-intro');
          document.getElementById('introductionContent').innerText = introText;
        });
      });
      
      document.querySelectorAll('.review-box').forEach(function(box) {
        box.addEventListener('click', function(e) {
          const animalId = this.getAttribute('data-animal-id');
          document.getElementById('reviewModal').style.display = 'block';
          document.getElementById('reviewList').style.display = 'block';
          document.getElementById('reviewForm').style.display = 'none';
          loadReviews(animalId);
          document.getElementById('reviewForm').setAttribute('data-animal-id', animalId);
          e.stopPropagation();
        });
      });
      
      document.querySelectorAll('.plus-menu-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          showPlusDropdown(this);
        });
      });
      
      const menuBtn = document.getElementById('menuBtn');
      const sidePanel = document.getElementById('sidePanel');
      const overlay = document.getElementById('overlay');
      menuBtn.addEventListener('click', function() {
        sidePanel.classList.toggle('open');
        overlay.classList.toggle('open');
      });
      overlay.addEventListener('click', function() {
        sidePanel.classList.remove('open');
        overlay.classList.remove('open');
      });
      
      const loginModal = document.getElementById('loginModal');
      const loginBtn = document.getElementById('loginBtn');
      const closeLoginModal = document.getElementById('closeLoginModal');
      loginBtn.addEventListener('click', function() { loginModal.style.display = 'block'; });
      closeLoginModal.addEventListener('click', function() { loginModal.style.display = 'none'; });
      
      const closeReviewModal = document.getElementById('closeReviewModal');
      closeReviewModal.addEventListener('click', function() {
        document.getElementById('reviewModal').style.display = 'none';
        document.getElementById('reviewForm').style.display = 'none';
      });
      
      // 待約清單 Modal 關閉按鈕
      const closePendingListModal = document.getElementById('closePendingListModal');
      closePendingListModal.addEventListener('click', function() {
        document.getElementById('pendingListModal').style.display = 'none';
      });
      
      // 點選待約清單按鈕，顯示待約清單 Modal
      const pendingListBtn = document.getElementById('pendingListBtn');
      pendingListBtn.addEventListener('click', function(e) {
        document.getElementById('pendingListModal').style.display = 'block';
        e.stopPropagation();
      });
      
      window.addEventListener('click', function(e) {
        if (e.target == loginModal) { loginModal.style.display = 'none'; }
        if (e.target == document.getElementById('reviewModal')) {
          document.getElementById('reviewModal').style.display = 'none';
          document.getElementById('reviewForm').style.display = 'none';
        }
        if (e.target == document.getElementById('pendingListModal')) {
          document.getElementById('pendingListModal').style.display = 'none';
        }
      });
      
      document.getElementById('reviewForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const animalId = this.getAttribute('data-animal-id');
        const formData = new FormData(this);
        formData.append('animal_id', animalId);
        submitReview(animalId, formData);
      });
      
      // 初始化臉蛋與氣質勾選框的最大勾選數限制
      limitCheckboxSelection('faceCheckboxes', 3);
      limitCheckboxSelection('temperamentCheckboxes', 3);
    });
    
    // 取得並以卡片方式呈現完整心得評論
    function loadReviews(animalId) {
      fetch(`/add_review/?animal_id=${animalId}`)
      .then(response => response.json())
      .then(data => {
        const reviewList = document.getElementById('reviewList');
        reviewList.innerHTML = "";
        data.reviews.forEach(review => {
          const reviewDiv = document.createElement('div');
          reviewDiv.className = "review-card";
          reviewDiv.innerHTML = `
            <div class="review-header">
              <div class="review-user-info">
                <span class="review-user">${review.user || '匿名'}</span>
                <span class="review-total">總心得數：${review.totalCount || 0}</span>
              </div>
              <span class="review-date">${review.created_at || ''}</span>
            </div>
            <div class="review-body">
              <div class="review-line">
                <div class="review-label"><strong>年紀</strong></div>
                <div class="review-value">${review.age || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>顏值</strong></div>
                <div class="review-value">${review.looks || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>臉蛋</strong></div>
                <div class="review-value">${review.face || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>氣質</strong></div>
                <div class="review-value">${review.temperament || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>體態</strong></div>
                <div class="review-value">${review.physique || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>罩杯</strong></div>
                <div class="review-value">${review.cup || ''} ${review.cup_size || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>膚質</strong></div>
                <div class="review-value">${review.skin_texture || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>膚色</strong></div>
                <div class="review-value">${review.skin_color || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>音樂</strong></div>
                <div class="review-value">${review.music || ''} ${review.music_price ? "(" + review.music_price + ")" : ""}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>體育</strong></div>
                <div class="review-value">${review.sports || ''} ${review.sports_price ? "(" + review.sports_price + ")" : ""}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>尺度</strong></div>
                <div class="review-value">${review.scale || ''}</div>
              </div>
              <div class="review-line">
                <div class="review-label"><strong>心得</strong></div>
                <div class="review-value">${review.content || ''}</div>
              </div>
            </div>
          `;
          reviewList.appendChild(reviewDiv);
        });
      });
    }
    
    // 提交心得評論（不重新載入頁面）
    function submitReview(animalId, formData) {
      fetch("/add_review/", {
        method: "POST",
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert(data.message);
          loadReviews(animalId);
          document.getElementById('reviewForm').reset();
          document.getElementById('reviewForm').style.display = 'none';
        } else {
          alert(data.error);
        }
      });
    }
  </script>
</body>
</html>
